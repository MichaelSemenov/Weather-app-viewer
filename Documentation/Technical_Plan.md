# Проект "Погода"

Weather-app-viewer - веб-приложение для просмотра текущей погоды. Пользователь может зарегистрироваться и посмотреть погоду в настоящее время, после чего главная страница приложения будет отображать список локаций с их текущей погодой.


## Мотивация проекта

- Использование cookies и сессий для авторизации пользователей 
- Работа с внешними API

## Функционал приложения

Работа с пользователями:
- Регистрация пользователей
- Авторизация
- Выход

Работа с локациями:
- Поиск по локации
- Добавление в список
- Просмотр погоды, для каждой локации отображается название и температура
- Удаление из списка


### Главная страница

- Заголовок
    - Для неавторизованных пользователей - кнопки регистрации и авторизации
    - Для авторизованных пользователей - логин текущего пользователя и кнопка Logout
- Контент
    - Поле ввода для поиска локации по названию
    - Список добавленных локаций. Каждый элемент списка отображает название, текущую температуру и кнопку "удалить"

### Страница результатов поиска локаций по названию

Переход на эту страницу будет осуществляется в результате заполнения поля ввода на главной странице, либо на странице результатов поиска.

Содержимое:
- Заголовок, такой же как на главной странице
- Поле ввода для поиска по названию - такое же, как на главной странице, чтобы не возвращаться туда для каждого нового поиска
- Список найденных локаций с кнопкой "добавить". При нажатии на кнопку происходит переход на главную страницу

### Остальное

- Страницы с формами регистрации и авторизации

## Работа с сессиями и cookies

Чтобы реализовать авторизацию пользователя и позволить браузеру "запоминать" авторизован ли текущий пользователь, мы будем использовать сессии и cookies.

При авторизации пользователя бэкенд приложение создаёт сессию с идентификатором, и устанавливает этот идентификатор в cookies HTTP ответа, которым приложение отвечает на POST запрос формы авторизации. К тому же, сессия содержит в себе ID авторизовавшегося юзера.

Далее, при каждом запросе к любой странице, бэкенд приложение анализирует cookies из запроса и определяет, существует ли сессия для ID из cookies. Если есть - страница рендерится для того пользователя, ID которого соответствует ID сессии из cookies.

Фреймворки, в том числе Spring Boot, умеют управлять всем этим. Одна из целей нашего проекта - поработать с cookies и сессиями вручную, чтобы понимать, как они работают.

## База данных

В нашем проекте мы будем использовать PostgresSQL для хранения информации о пользователях.

### Таблица `Users`

| Колонка  | Тип     | Комментарий                                                                                |
|----------|---------|--------------------------------------------------------------------------------------------|
| ID       | int     | Айди пользователя, автоинкремент, первичный ключ                                           |
| Login    | Varchar | Логин пользователя, username или email                                                     |
| Password | Varchar | Хранить пароль в открытом виде небезопасно, для этого используется шифрование BCrypt |

### Таблица `Locations`

Локации пользователя, в которых он хочет знать погоду. Одна и та же локация может повторяться для нескольких пользователей.

| Колонка   | Тип     | Комментарий                                 |
|-----------|---------|---------------------------------------------|
| ID        | int     | Айди локации, автоинкремент, первичный ключ |
| Name      | Varchar | Название                                    |
| UserId    | int     | Пользователь, добавивший эту локацию        |
| Latitude  | Decimal | Широта локации                              |
| Longitude | Decimal | Долгота локации                             |

### Таблица `Sessions`

| Колонка   | Тип      | Комментарий                                                          |
|-----------|----------|----------------------------------------------------------------------|
| ID        | Varchar  | Айди сессии, GUID, первичный ключ                                    |
| UserId    | int      | Пользователь, для которого сессия создана                            |
| ExpiresAt | Datetime | Время истечения сессии. Равно времени создания сессии плюс `N` часов |

## Получение информации о погоде с помощью OpenWeatherMap API

В этом проекте мы планируем использовать чужое API, потому что нам нужно искать локации по названию и получать погоду для локации.

### OpenWeather

Существует множество сервисов, предоставляющих API с таким функционалом. Мы рассмотрели этот вариант, потому что он позволяет бесплатно совершать 60 запросов в минуту.

Для выполнения запросов к API нужен ключ, для его получения необходимо:
- Зарегистрироваться на [https://openweathermap.org/](https://openweathermap.org/)
- Создать бесплатный ключ с лимитом 60 запросов в минуту
- Дождаться активации ключа 

### Работа с API

Документация - [https://openweathermap.org/api](https://openweathermap.org/api).

Нам нужно 2 метода API:
- Поиск локаций по названию - [https://openweathermap.org/current#geocoding](https://openweathermap.org/current#geocoding)
- Получение погоды по координатам локации - [https://openweathermap.org/current#one](https://openweathermap.org/current#one)

Первым делом следует поэкспериментировать с API вручную, чтобы понять как делать запросы, и что приходит в ответе. Сделать это можно в [HTTP клиенте](https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html) встроенном в Intellij IDEA, либо воспользоваться отдельным приложением, например [https://insomnia.rest/](https://insomnia.rest/).

### Интеграция OpenWeather API с Java приложением

Шаги:
- Делаем запрос
- Получаем ответ
- Десериализуем ответ в объект Java

Для работы с API потребуется HTTP Client, например [https://www.baeldung.com/java-9-http-client](https://www.baeldung.com/java-9-http-client).

С десериализацией поможет `JsonMapper` из библиотеки Jackson.

## Тесты

### Интеграционные тесты сервисов по работе с пользователями и сессиями

Мы покроем тестами связку данных с классами-сервисами, отвечающими за пользователей и сессии.

Например, вызов метода регистрации в классе-сервисе, отвечающем за работу с пользователями, должен привести к тому, что в таблице `Users` появляется новая запись. Если при регистрации автоматически создается сессия, так же можем проверить, что она была создана.

Также мы проверим тестами:
- Регистрацию юзера с неуникальным логином приводит к exception
- Истекание сессии


### Интеграционные тесты для сервиса по работе с OpenWeather API

Покроем тестами связку HTTP клиента и класса-сервиса, который пользуется этим клиентом для получения данных. Для того чтобы не делать настоящие запросы к API во время прогона тестов, следует использовать мок HTTP клиента и его ответов.

Пример - запрашиваем список локаций у сервиса, мок HTTP клиента возвращает заданный в тесте ответ (в виде строки, например), сервис его парсит и возвращает коллекцию объектов-моделей. Проверяем, что коллеция содержит ожидаемую локацию.

Что ещё стоит проверить тестами:
- В случай ошибки (статусы 4xx, 5xx) от OpenWeather API сервис выбрасывает ожидаемый тип исключения

## Деплой

Будем вручную деплоить war артефакт в Tomcat, установленный на удалённом сервере. Потребуется установка внешней SQL БД.

Шаги:
- Локально собрать war артефакт приложения
- В хостинг-провайдере по выбору арендовать облачный сервер
- Установить JRE, Tomcat, PosrgreSQL
- Зайти в админский интерфейс Tomcat, установить собранный war артефакт

Ожидаемый результат - приложение доступно по адресу `http://$server_ip:8080/$app_root_path`.

## План работы над приложением

- Создать заготовку Java бэкенд приложения с `javax.servlet`
- Написать модели сущностей БД - `User`, `Location`, `Session`
- С помощью Thymeleaf создать страницы авторизации и регистрации
- В обработчиках форм авторизации и регистрации реализовать бизнес логику работы с сессиями, cookies, БД
- Тесты для сервиса регистрации 
- Написать сервис для работы с OpenWeather API
- Тесты для OpenWeather API
- Реализовать логику приложения - поиск, добавление, удаление локаций, просмотр погоды
- Создать интерфейс главной страницы и страницы поиска локаций
- Деплой